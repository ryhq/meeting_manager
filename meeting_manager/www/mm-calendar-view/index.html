{% extends "templates/web.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_include %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@fullcalendar/resource-timeline@6.1.10/main.min.css" rel="stylesheet">

<style>
	body {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		background-color: #f5f7fa;
	}

	.calendar-container {
		max-width: 1400px;
		margin: 20px auto;
		padding: 20px;
	}

	.calendar-header {
		background: white;
		padding: 20px;
		border-radius: 8px;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
		margin-bottom: 20px;
	}

	.calendar-header h1 {
		margin: 0 0 20px 0;
		font-size: 24px;
		font-weight: 700;
		color: #1f2937;
	}

	.calendar-filters {
		display: flex;
		gap: 15px;
		flex-wrap: wrap;
		align-items: center;
	}

	.filter-group {
		display: flex;
		flex-direction: column;
		gap: 5px;
	}

	.filter-group label {
		font-size: 12px;
		font-weight: 600;
		color: #6b7280;
		text-transform: uppercase;
	}

	.filter-group select {
		padding: 8px 12px;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		font-size: 14px;
		min-width: 200px;
		background-color: white;
	}

	.filter-group select:focus {
		outline: none;
		border-color: #3b82f6;
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	.view-switcher {
		display: flex;
		gap: 5px;
		background: #f3f4f6;
		padding: 4px;
		border-radius: 6px;
	}

	.view-switcher button {
		padding: 8px 16px;
		border: none;
		background: transparent;
		border-radius: 4px;
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		color: #6b7280;
		transition: all 0.2s;
	}

	.view-switcher button.active {
		background: white;
		color: #1f2937;
		box-shadow: 0 1px 2px rgba(0,0,0,0.05);
	}

	.view-switcher button:hover:not(.active) {
		color: #1f2937;
	}

	.calendar-body {
		background: white;
		padding: 20px;
		border-radius: 8px;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}

	#calendar {
		min-height: 600px;
	}

	.legend {
		display: flex;
		gap: 20px;
		margin-top: 20px;
		padding: 15px;
		background: #f9fafb;
		border-radius: 6px;
		flex-wrap: wrap;
	}

	.legend-item {
		display: flex;
		align-items: center;
		gap: 8px;
		font-size: 14px;
		color: #6b7280;
	}

	.legend-color {
		width: 16px;
		height: 16px;
		border-radius: 3px;
	}

	/* Event detail modal */
	.modal {
		display: none;
		position: fixed;
		z-index: 1000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0,0,0,0.5);
	}

	.modal.show {
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.modal-content {
		background-color: white;
		border-radius: 8px;
		padding: 0;
		width: 90%;
		max-width: 600px;
		max-height: 80vh;
		overflow-y: auto;
		box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
	}

	.modal-header {
		padding: 20px;
		border-bottom: 1px solid #e5e7eb;
	}

	.modal-header h2 {
		margin: 0;
		font-size: 20px;
		font-weight: 700;
		color: #1f2937;
	}

	.modal-body {
		padding: 20px;
	}

	.modal-footer {
		padding: 20px;
		border-top: 1px solid #e5e7eb;
		display: flex;
		justify-content: space-between;
		gap: 10px;
	}

	.detail-row {
		display: flex;
		padding: 12px 0;
		border-bottom: 1px solid #f3f4f6;
	}

	.detail-row:last-child {
		border-bottom: none;
	}

	.detail-label {
		font-weight: 600;
		color: #6b7280;
		min-width: 140px;
	}

	.detail-value {
		color: #1f2937;
		flex: 1;
	}

	.btn {
		padding: 10px 16px;
		border: none;
		border-radius: 6px;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-primary {
		background: #3b82f6;
		color: white;
	}

	.btn-primary:hover {
		background: #2563eb;
	}

	.btn-secondary {
		background: #e5e7eb;
		color: #374151;
	}

	.btn-secondary:hover {
		background: #d1d5db;
	}

	.btn-danger {
		background: #ef4444;
		color: white;
	}

	.btn-danger:hover {
		background: #dc2626;
	}

	.btn-success {
		background: #10b981;
		color: white;
	}

	.btn-success:hover {
		background: #059669;
	}

	.status-badge {
		display: inline-block;
		padding: 4px 12px;
		border-radius: 12px;
		font-size: 12px;
		font-weight: 600;
	}

	.status-confirmed {
		background: #d1fae5;
		color: #065f46;
	}

	.status-pending {
		background: #fef3c7;
		color: #92400e;
	}

	.status-cancelled {
		background: #fee2e2;
		color: #991b1b;
	}

	.status-completed {
		background: #dbeafe;
		color: #1e40af;
	}

	.status-no-show {
		background: #f3f4f6;
		color: #374151;
	}

	.loading {
		text-align: center;
		padding: 40px;
		color: #6b7280;
	}

	.spinner {
		border: 3px solid #f3f4f6;
		border-top: 3px solid #3b82f6;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		animation: spin 1s linear infinite;
		margin: 0 auto 16px;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	/* Resource Timeline Styling */
	.fc-timeline-slot {
		border-color: #e5e7eb !important;
	}

	.fc-timeline-event {
		border-radius: 4px !important;
		font-size: 12px !important;
		padding: 2px 4px !important;
	}

	.fc-resource-timeline .fc-datagrid-cell {
		padding: 8px 12px !important;
		font-weight: 500 !important;
	}

	.fc-timeline-slot-label {
		font-size: 13px !important;
		font-weight: 500 !important;
	}

	.fc-resource-timeline-divider {
		background-color: #d1d5db !important;
	}

	@media (max-width: 768px) {
		.calendar-filters {
			flex-direction: column;
			align-items: stretch;
		}

		.filter-group select {
			width: 100%;
		}

		.modal-footer {
			flex-direction: column;
		}

		.btn {
			width: 100%;
		}
	}
</style>
{% endblock %}

{% block page_content %}
<div class="calendar-container">
	<!-- Calendar Header -->
	<div class="calendar-header">
		<h1>ðŸ“… {{ title }}</h1>

		<div class="calendar-filters">
			<!-- Department Filter -->
			<div class="filter-group">
				<label>Department</label>
				<select id="department-filter">
					<option value="">All Departments</option>
					{% for dept in departments %}
					<option value="{{ dept.name }}" {% if dept.name == selected_department %}selected{% endif %}>
						{{ dept.department_name }}
					</option>
					{% endfor %}
				</select>
			</div>

			<!-- Member Filter -->
			<div class="filter-group">
				<label>Team Member</label>
				<select id="member-filter">
					<option value="">All Members</option>
					{% for member in members %}
					<option value="{{ member.user_id }}" {% if member.user_id == selected_member %}selected{% endif %}>
						{{ member.full_name }}
					</option>
					{% endfor %}
				</select>
			</div>

			<!-- View Switcher -->
			<div class="filter-group">
				<label>View</label>
				<div class="view-switcher">
					<button id="timeline-view" class="active" onclick="switchView('resourceTimelineDay')">Timeline</button>
					<button id="month-view" onclick="switchView('dayGridMonth')">Month</button>
					<button id="week-view" onclick="switchView('timeGridWeek')">Week</button>
					<button id="day-view" onclick="switchView('timeGridDay')">Day</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Calendar Body -->
	<div class="calendar-body">
		<div id="calendar"></div>

		<!-- Legend -->
		<div class="legend">
			<div class="legend-item">
				<div class="legend-color" style="background-color: #10b981;"></div>
				<span>Confirmed</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #f59e0b;"></div>
				<span>Pending</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #ef4444;"></div>
				<span>Cancelled</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #3b82f6;"></div>
				<span>Completed</span>
			</div>
			<div class="legend-item">
				<div class="legend-color" style="background-color: #6b7280;"></div>
				<span>No-show</span>
			</div>
		</div>
	</div>
</div>

<!-- Event Detail Modal -->
<div id="event-modal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2 id="modal-title">Booking Details</h2>
		</div>
		<div class="modal-body" id="modal-body">
			<!-- Will be populated dynamically -->
		</div>
		<div class="modal-footer" id="modal-footer">
			<button class="btn btn-secondary" onclick="closeModal()">Close</button>
		</div>
	</div>
</div>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/resource-timeline@6.1.10/main.min.js"></script>

<script>
let calendar;
let currentView = 'resourceTimelineDay';
const userRoles = {{ user_roles | tojson }};
const isSystemManager = {{ 'true' if is_system_manager else 'false' }};
const isDepartmentLeader = {{ 'true' if is_department_leader else 'false' }};

document.addEventListener('DOMContentLoaded', function() {
	initializeCalendar();
	setupFilterListeners();
});

function initializeCalendar() {
	const calendarEl = document.getElementById('calendar');

	calendar = new FullCalendar.Calendar(calendarEl, {
		initialView: currentView,
		headerToolbar: {
			left: 'prev,next today',
			center: 'title',
			right: ''
		},
		editable: isSystemManager || isDepartmentLeader,
		droppable: false,
		eventDurationEditable: false,
		// Resource Timeline Configuration
		schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
		resourceAreaHeaderContent: 'Team Members',
		resourceAreaWidth: '200px',
		resources: function(info, successCallback, failureCallback) {
			loadResources(successCallback, failureCallback);
		},
		events: function(info, successCallback, failureCallback) {
			loadEvents(info.startStr, info.endStr, successCallback, failureCallback);
		},
		eventClick: function(info) {
			showEventDetails(info.event);
		},
		eventDrop: function(info) {
			handleEventDrop(info);
		},
		eventResize: function(info) {
			info.revert(); // Don't allow resizing for now
		},
		height: 'auto',
		slotMinTime: '07:00:00',
		slotMaxTime: '22:00:00',
		slotDuration: '00:15:00',
		slotLabelInterval: '01:00',
		allDaySlot: false,
		nowIndicator: true,
		eventTimeFormat: {
			hour: '2-digit',
			minute: '2-digit',
			meridiem: 'short'
		},
		slotLabelFormat: {
			hour: '2-digit',
			minute: '2-digit',
			meridiem: 'short'
		}
	});

	calendar.render();
}

function loadResources(successCallback, failureCallback) {
	const department = document.getElementById('department-filter').value;

	frappe.call({
		method: 'meeting_manager.www.mm-calendar-view.index.get_department_members',
		args: {
			department: department || null
		},
		callback: function(r) {
			if (r.message) {
				// Transform members into FullCalendar resource format
				const resources = r.message.map(member => ({
					id: member.id,
					title: member.title
				}));
				successCallback(resources);
			} else {
				failureCallback();
			}
		},
		error: function() {
			failureCallback();
		}
	});
}

function loadEvents(start, end, successCallback, failureCallback) {
	const department = document.getElementById('department-filter').value;
	const member = document.getElementById('member-filter').value;

	frappe.call({
		method: 'meeting_manager.www.mm-calendar-view.index.get_calendar_events',
		args: {
			department: department,
			member: member,
			start: start,
			end: end
		},
		callback: function(r) {
			if (r.message) {
				successCallback(r.message);
			} else {
				failureCallback();
			}
		},
		error: function() {
			failureCallback();
		}
	});
}

function setupFilterListeners() {
	document.getElementById('department-filter').addEventListener('change', function() {
		const department = this.value;

		// Load members for selected department
		if (department) {
			frappe.call({
				method: 'meeting_manager.www.mm-calendar-view.index.get_department_members',
				args: { department: department },
				callback: function(r) {
					const memberSelect = document.getElementById('member-filter');
					memberSelect.innerHTML = '<option value="">All Members</option>';

					if (r.message) {
						r.message.forEach(member => {
							const option = document.createElement('option');
							option.value = member.id;
							option.textContent = member.title;
							memberSelect.appendChild(option);
						});
					}
				}
			});
		}

		// Refetch both resources and events when department changes
		calendar.refetchResources();
		calendar.refetchEvents();
	});

	document.getElementById('member-filter').addEventListener('change', function() {
		calendar.refetchEvents();
	});
}

function switchView(viewName) {
	currentView = viewName;
	calendar.changeView(viewName);

	// Update active button
	document.querySelectorAll('.view-switcher button').forEach(btn => btn.classList.remove('active'));

	if (viewName === 'resourceTimelineDay') {
		document.getElementById('timeline-view').classList.add('active');
	} else if (viewName === 'dayGridMonth') {
		document.getElementById('month-view').classList.add('active');
	} else if (viewName === 'timeGridWeek') {
		document.getElementById('week-view').classList.add('active');
	} else if (viewName === 'timeGridDay') {
		document.getElementById('day-view').classList.add('active');
	}
}

function showEventDetails(event) {
	const props = event.extendedProps;

	const statusClass = 'status-' + props.status.toLowerCase().replace(' ', '-').replace('no-show', 'no-show');

	let detailsHTML = `
		<div class="detail-row">
			<div class="detail-label">Booking Reference:</div>
			<div class="detail-value"><strong>${props.booking_reference}</strong></div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Status:</div>
			<div class="detail-value"><span class="status-badge ${statusClass}">${props.status}</span></div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Type:</div>
			<div class="detail-value">${props.booking_type}</div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Meeting Type:</div>
			<div class="detail-value">${props.meeting_type_name}</div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Assigned To:</div>
			<div class="detail-value">${props.assigned_to_name}</div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Date & Time:</div>
			<div class="detail-value">${event.start.toLocaleString()}</div>
		</div>
		<div class="detail-row">
			<div class="detail-label">Duration:</div>
			<div class="detail-value">${props.duration} minutes</div>
		</div>
	`;

	if (props.booking_type === 'Customer Booking') {
		detailsHTML += `
			<div class="detail-row">
				<div class="detail-label">Customer Name:</div>
				<div class="detail-value">${props.customer_name || 'N/A'}</div>
			</div>
			<div class="detail-row">
				<div class="detail-label">Customer Email:</div>
				<div class="detail-value">${props.customer_email || 'N/A'}</div>
			</div>
			<div class="detail-row">
				<div class="detail-label">Customer Phone:</div>
				<div class="detail-value">${props.customer_phone || 'N/A'}</div>
			</div>
		`;
	}

	detailsHTML += `
		<div class="detail-row">
			<div class="detail-label">Location:</div>
			<div class="detail-value">${props.location_type}${props.video_platform ? ' - ' + props.video_platform : ''}</div>
		</div>
	`;

	if (props.meeting_link) {
		detailsHTML += `
			<div class="detail-row">
				<div class="detail-label">Meeting Link:</div>
				<div class="detail-value"><a href="${props.meeting_link}" target="_blank">${props.meeting_link}</a></div>
			</div>
		`;
	}

	document.getElementById('modal-title').textContent = event.title;
	document.getElementById('modal-body').innerHTML = detailsHTML;

	// Show action buttons based on permissions and status
	let footerHTML = '';

	if ((isSystemManager || isDepartmentLeader) && props.status === 'Confirmed') {
		footerHTML += `
			<div style="display: flex; gap: 10px; flex-wrap: wrap;">
				<button class="btn btn-success" onclick="markAsCompleted('${props.booking_id}')">Mark Complete</button>
				<button class="btn btn-secondary" onclick="markAsNoShow('${props.booking_id}')">Mark No-Show</button>
				<button class="btn btn-danger" onclick="cancelBooking('${props.booking_id}')">Cancel</button>
			</div>
		`;
	}

	footerHTML += '<button class="btn btn-secondary" onclick="closeModal()">Close</button>';

	document.getElementById('modal-footer').innerHTML = footerHTML;
	document.getElementById('event-modal').classList.add('show');
}

function closeModal() {
	document.getElementById('event-modal').classList.remove('show');
}

function handleEventDrop(info) {
	const event = info.event;
	const props = event.extendedProps;

	if (props.status !== 'Confirmed') {
		frappe.msgprint('Only confirmed bookings can be rescheduled');
		info.revert();
		return;
	}

	const newDate = event.start.toISOString().split('T')[0];
	const newTime = event.start.toTimeString().slice(0, 5);

	frappe.confirm(
		`Reschedule this booking to ${event.start.toLocaleString()}?`,
		function() {
			frappe.call({
				method: 'meeting_manager.meeting_manager.api.booking.reschedule_booking_internal',
				args: {
					booking_id: props.booking_id,
					new_date: newDate,
					new_time: newTime,
					reason: 'Rescheduled via drag-and-drop'
				},
				callback: function(r) {
					if (r.message && r.message.success) {
						frappe.show_alert({message: r.message.message, indicator: 'green'});
						calendar.refetchEvents();
					} else {
						frappe.msgprint('Failed to reschedule booking');
						info.revert();
					}
				},
				error: function() {
					frappe.msgprint('Error rescheduling booking');
					info.revert();
				}
			});
		},
		function() {
			info.revert();
		}
	);
}

function markAsCompleted(bookingId) {
	frappe.call({
		method: 'meeting_manager.meeting_manager.api.booking.update_booking_status',
		args: {
			booking_id: bookingId,
			new_status: 'Completed',
			notes: 'Marked as completed from calendar view'
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.show_alert({message: 'Booking marked as completed', indicator: 'green'});
				closeModal();
				calendar.refetchEvents();
			}
		}
	});
}

function markAsNoShow(bookingId) {
	frappe.call({
		method: 'meeting_manager.meeting_manager.api.booking.update_booking_status',
		args: {
			booking_id: bookingId,
			new_status: 'No-show',
			notes: 'Marked as no-show from calendar view'
		},
		callback: function(r) {
			if (r.message && r.message.success) {
				frappe.show_alert({message: 'Booking marked as no-show', indicator: 'orange'});
				closeModal();
				calendar.refetchEvents();
			}
		}
	});
}

function cancelBooking(bookingId) {
	frappe.prompt([
		{
			label: 'Cancellation Reason',
			fieldname: 'reason',
			fieldtype: 'Small Text',
			reqd: 1
		}
	],
	function(values) {
		frappe.call({
			method: 'meeting_manager.meeting_manager.api.booking.update_booking_status',
			args: {
				booking_id: bookingId,
				new_status: 'Cancelled',
				notes: values.reason
			},
			callback: function(r) {
				if (r.message && r.message.success) {
					frappe.show_alert({message: 'Booking cancelled', indicator: 'red'});
					closeModal();
					calendar.refetchEvents();
				}
			}
		});
	},
	'Cancel Booking',
	'Cancel'
	);
}

// Close modal when clicking outside
window.onclick = function(event) {
	const modal = document.getElementById('event-modal');
	if (event.target == modal) {
		closeModal();
	}
}
</script>
{% endblock %}
