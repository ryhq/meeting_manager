{% extends "templates/web.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_include %}
<style>
	body {
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		background-color: #f5f7fa;
	}

	.form-container {
		max-width: 800px;
		margin: 40px auto;
		padding: 20px;
	}

	.form-card {
		background: white;
		padding: 30px;
		border-radius: 8px;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}

	.form-card h1 {
		margin: 0 0 10px 0;
		font-size: 28px;
		font-weight: 700;
		color: #1f2937;
	}

	.form-description {
		color: #6b7280;
		margin-bottom: 30px;
		font-size: 14px;
	}

	.form-tabs {
		display: flex;
		gap: 10px;
		margin-bottom: 30px;
		border-bottom: 2px solid #e5e7eb;
	}

	.form-tab {
		padding: 12px 24px;
		background: none;
		border: none;
		border-bottom: 3px solid transparent;
		cursor: pointer;
		font-size: 16px;
		font-weight: 600;
		color: #6b7280;
		margin-bottom: -2px;
		transition: all 0.2s;
	}

	.form-tab.active {
		color: #3b82f6;
		border-bottom-color: #3b82f6;
	}

	.form-tab:hover:not(.active) {
		color: #1f2937;
	}

	.form-section {
		display: none;
	}

	.form-section.active {
		display: block;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-group label {
		display: block;
		font-size: 14px;
		font-weight: 600;
		color: #374151;
		margin-bottom: 8px;
	}

	.form-group label.required::after {
		content: " *";
		color: #ef4444;
	}

	.form-group input,
	.form-group select,
	.form-group textarea {
		width: 100%;
		padding: 10px 14px;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		font-size: 14px;
		font-family: inherit;
		transition: all 0.2s;
	}

	.form-group input:focus,
	.form-group select:focus,
	.form-group textarea:focus {
		outline: none;
		border-color: #3b82f6;
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	.form-group textarea {
		resize: vertical;
		min-height: 100px;
	}

	.form-group .help-text {
		font-size: 13px;
		color: #6b7280;
		margin-top: 6px;
	}

	.form-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 20px;
	}

	.availability-status {
		padding: 12px;
		border-radius: 6px;
		margin-top: 10px;
		font-size: 14px;
	}

	.availability-status.available {
		background: #d1fae5;
		color: #065f46;
		border: 1px solid #10b981;
	}

	.availability-status.unavailable {
		background: #fee2e2;
		color: #991b1b;
		border: 1px solid #ef4444;
	}

	.availability-status.checking {
		background: #fef3c7;
		color: #92400e;
		border: 1px solid #f59e0b;
	}

	.btn-group {
		display: flex;
		gap: 12px;
		margin-top: 30px;
		padding-top: 20px;
		border-top: 1px solid #e5e7eb;
	}

	.btn {
		padding: 12px 24px;
		border: none;
		border-radius: 6px;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-primary {
		background: #3b82f6;
		color: white;
		flex: 1;
	}

	.btn-primary:hover:not(:disabled) {
		background: #2563eb;
	}

	.btn-primary:disabled {
		background: #9ca3af;
		cursor: not-allowed;
	}

	.btn-secondary {
		background: #e5e7eb;
		color: #374151;
		padding: 12px 20px;
	}

	.btn-secondary:hover {
		background: #d1d5db;
	}

	.multi-select-container {
		border: 1px solid #d1d5db;
		border-radius: 6px;
		padding: 10px;
		max-height: 200px;
		overflow-y: auto;
	}

	.multi-select-option {
		display: flex;
		align-items: center;
		padding: 8px;
		border-radius: 4px;
		cursor: pointer;
		transition: background 0.2s;
	}

	.multi-select-option:hover {
		background: #f3f4f6;
	}

	.multi-select-option input[type="checkbox"] {
		width: auto;
		margin-right: 10px;
	}

	.success-message {
		background: #d1fae5;
		color: #065f46;
		padding: 16px;
		border-radius: 6px;
		margin-bottom: 20px;
		border: 1px solid #10b981;
	}

	.success-message h3 {
		margin: 0 0 8px 0;
		font-size: 16px;
	}

	.success-message p {
		margin: 4px 0;
		font-size: 14px;
	}

	.error-message {
		background: #fee2e2;
		color: #991b1b;
		padding: 16px;
		border-radius: 6px;
		margin-bottom: 20px;
		border: 1px solid #ef4444;
	}

	@media (max-width: 768px) {
		.form-row {
			grid-template-columns: 1fr;
		}

		.form-tabs {
			flex-direction: column;
		}

		.form-tab {
			text-align: left;
		}

		.btn-group {
			flex-direction: column-reverse;
		}

		.btn {
			width: 100%;
		}
	}
</style>
{% endblock %}

{% block page_content %}
<div class="form-container">
	<div class="form-card">
		<!-- Form Tabs -->
		<div class="form-tabs">
			<button class="form-tab {% if form_type == 'internal' %}active{% endif %}"
					onclick="switchFormType('internal')">
				Internal Meeting
			</button>
			<button class="form-tab {% if form_type == 'customer' %}active{% endif %}"
					onclick="switchFormType('customer')">
				Customer Meeting
			</button>
		</div>

		<!-- Internal Meeting Form -->
		<div id="internal-form" class="form-section {% if form_type == 'internal' %}active{% endif %}">
			<h1>ü§ù Create Internal Meeting</h1>
			<p class="form-description">
				Schedule an internal meeting between team members. All participants will receive calendar invites.
			</p>

			<div id="internal-success" style="display: none;"></div>
			<div id="internal-error" style="display: none;"></div>

			<form id="internal-meeting-form">
				<div class="form-group">
					<label class="required">Department</label>
					<select id="internal-department" required onchange="loadInternalMeetingTypes()">
						<option value="">Select Department</option>
						{% for dept in departments %}
						<option value="{{ dept.name }}">{{ dept.department_name }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="form-group">
					<label class="required">Meeting Type</label>
					<select id="internal-meeting-type" required>
						<option value="">Select Meeting Type</option>
					</select>
					<div class="help-text">Only internal meeting types are shown</div>
				</div>

				<div class="form-group">
					<label class="required">Participants</label>
					<div id="internal-participants" class="multi-select-container">
						<p style="color: #6b7280; text-align: center;">Select a department first</p>
					</div>
					<div class="help-text">Select team members to invite to this meeting</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="required">Date</label>
						<input type="date" id="internal-date" required min="{{ frappe.utils.today() }}">
					</div>

					<div class="form-group">
						<label class="required">Time</label>
						<input type="time" id="internal-time" required>
					</div>
				</div>

				<div class="form-group">
					<label>Meeting Agenda</label>
					<textarea id="internal-agenda" placeholder="What will be discussed in this meeting?"></textarea>
				</div>

				<div class="form-group">
					<label>Meeting Notes</label>
					<textarea id="internal-notes" placeholder="Additional notes or preparation items"></textarea>
				</div>

				<div class="btn-group">
					<button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
					<button type="submit" class="btn btn-primary" id="internal-submit">
						Create Internal Meeting
					</button>
				</div>
			</form>
		</div>

		<!-- Customer Meeting Form -->
		<div id="customer-form" class="form-section {% if form_type == 'customer' %}active{% endif %}">
			<h1>üë§ Create Customer Meeting</h1>
			<p class="form-description">
				Create a customer booking and assign it to a specific team member. Confirmation emails will be sent to both the customer and the assigned team member.
			</p>

			<div id="customer-success" style="display: none;"></div>
			<div id="customer-error" style="display: none;"></div>

			<form id="customer-meeting-form">
				<div class="form-group">
					<label class="required">Department</label>
					<select id="customer-department" required onchange="loadCustomerMeetingTypes(); loadCustomerMembers();">
						<option value="">Select Department</option>
						{% for dept in departments %}
						<option value="{{ dept.name }}">{{ dept.department_name }}</option>
						{% endfor %}
					</select>
				</div>

				<div class="form-group">
					<label class="required">Meeting Type</label>
					<select id="customer-meeting-type" required onchange="updateDuration()">
						<option value="">Select Meeting Type</option>
					</select>
				</div>

				<div class="form-group">
					<label class="required">Assign To</label>
					<select id="customer-assigned-to" required onchange="checkMemberAvailability()">
						<option value="">Select Team Member</option>
					</select>
					<div class="help-text">Select which team member will handle this meeting</div>
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="required">Date</label>
						<input type="date" id="customer-date" required min="{{ frappe.utils.today() }}" onchange="checkMemberAvailability()">
					</div>

					<div class="form-group">
						<label class="required">Time</label>
						<input type="time" id="customer-time" required onchange="checkMemberAvailability()">
					</div>
				</div>

				<div id="availability-check"></div>

				<h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 18px; color: #1f2937;">Customer Information</h3>

				<div class="form-group">
					<label class="required">Customer Name</label>
					<input type="text" id="customer-name" required placeholder="John Doe">
				</div>

				<div class="form-row">
					<div class="form-group">
						<label class="required">Customer Email</label>
						<input type="email" id="customer-email" required placeholder="john@example.com">
					</div>

					<div class="form-group">
						<label class="required">Customer Phone</label>
						<input type="tel" id="customer-phone" required placeholder="+1 234 567 8900">
					</div>
				</div>

				<div class="form-group">
					<label>Customer Notes</label>
					<textarea id="customer-notes" placeholder="Any special requests or information from the customer"></textarea>
				</div>

				<div class="btn-group">
					<button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
					<button type="submit" class="btn btn-primary" id="customer-submit">
						Create Customer Meeting
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
let currentDuration = 0;

function switchFormType(type) {
	// Update tabs
	document.querySelectorAll('.form-tab').forEach(tab => tab.classList.remove('active'));
	event.target.classList.add('active');

	// Update forms
	document.querySelectorAll('.form-section').forEach(section => section.classList.remove('active'));
	document.getElementById(type + '-form').classList.add('active');

	// Update URL
	const url = new URL(window.location);
	url.searchParams.set('type', type);
	window.history.pushState({}, '', url);
}

// Internal Meeting Functions
function loadInternalMeetingTypes() {
	const department = document.getElementById('internal-department').value;
	const meetingTypeSelect = document.getElementById('internal-meeting-type');

	if (!department) {
		meetingTypeSelect.innerHTML = '<option value="">Select Meeting Type</option>';
		return;
	}

	frappe.call({
		method: 'meeting_manager.www.create-meeting.index.get_meeting_types',
		args: { department: department },
		callback: function(r) {
			meetingTypeSelect.innerHTML = '<option value="">Select Meeting Type</option>';

			if (r.message) {
				r.message.filter(mt => mt.is_internal).forEach(mt => {
					const option = document.createElement('option');
					option.value = mt.name;
					option.textContent = `${mt.meeting_name} (${mt.duration} min)`;
					option.dataset.duration = mt.duration;
					meetingTypeSelect.appendChild(option);
				});
			}
		}
	});

	loadInternalParticipants(department);
}

function loadInternalParticipants(department) {
	frappe.call({
		method: 'meeting_manager.www.create-meeting.index.get_department_members_list',
		args: { department: department },
		callback: function(r) {
			const container = document.getElementById('internal-participants');
			container.innerHTML = '';

			if (r.message && r.message.length > 0) {
				r.message.forEach(member => {
					const div = document.createElement('div');
					div.className = 'multi-select-option';
					div.innerHTML = `
						<input type="checkbox" name="participant" value="${member.user_id}" id="p-${member.user_id}">
						<label for="p-${member.user_id}" style="margin: 0; cursor: pointer; flex: 1;">
							${member.full_name} (${member.email})
						</label>
					`;
					container.appendChild(div);
				});
			} else {
				container.innerHTML = '<p style="color: #6b7280; text-align: center;">No members found</p>';
			}
		}
	});
}

document.getElementById('internal-meeting-form').addEventListener('submit', function(e) {
	e.preventDefault();

	const participants = Array.from(document.querySelectorAll('input[name="participant"]:checked')).map(cb => cb.value);

	if (participants.length === 0) {
		showError('internal', 'Please select at least one participant');
		return;
	}

	const meetingType = document.getElementById('internal-meeting-type');
	const selectedOption = meetingType.options[meetingType.selectedIndex];

	const data = {
		meeting_type: meetingType.value,
		participants: participants,
		scheduled_date: document.getElementById('internal-date').value,
		scheduled_start_time: document.getElementById('internal-time').value,
		meeting_agenda: document.getElementById('internal-agenda').value,
		meeting_notes: document.getElementById('internal-notes').value
	};

	document.getElementById('internal-submit').disabled = true;
	document.getElementById('internal-submit').textContent = 'Creating...';

	frappe.call({
		method: 'meeting_manager.meeting_manager.api.booking.create_internal_meeting',
		args: { meeting_data: data },
		callback: function(r) {
			if (r.message && r.message.success) {
				showSuccess('internal', `
					<h3>‚úÖ Internal Meeting Created!</h3>
					<p><strong>Booking ID:</strong> ${r.message.booking_id}</p>
					<p>${r.message.message}</p>
				`);
				document.getElementById('internal-meeting-form').reset();
			} else {
				showError('internal', r.message.message || 'Failed to create meeting');
			}
		},
		error: function(err) {
			showError('internal', err.message || 'An error occurred while creating the meeting');
		},
		always: function() {
			document.getElementById('internal-submit').disabled = false;
			document.getElementById('internal-submit').textContent = 'Create Internal Meeting';
		}
	});
});

// Customer Meeting Functions
function loadCustomerMeetingTypes() {
	const department = document.getElementById('customer-department').value;
	const meetingTypeSelect = document.getElementById('customer-meeting-type');

	if (!department) {
		meetingTypeSelect.innerHTML = '<option value="">Select Meeting Type</option>';
		return;
	}

	frappe.call({
		method: 'meeting_manager.www.create-meeting.index.get_meeting_types',
		args: { department: department },
		callback: function(r) {
			meetingTypeSelect.innerHTML = '<option value="">Select Meeting Type</option>';

			if (r.message) {
				r.message.filter(mt => mt.is_public).forEach(mt => {
					const option = document.createElement('option');
					option.value = mt.name;
					option.textContent = `${mt.meeting_name} (${mt.duration} min)`;
					option.dataset.duration = mt.duration;
					meetingTypeSelect.appendChild(option);
				});
			}
		}
	});
}

function loadCustomerMembers() {
	const department = document.getElementById('customer-department').value;
	const memberSelect = document.getElementById('customer-assigned-to');

	if (!department) {
		memberSelect.innerHTML = '<option value="">Select Team Member</option>';
		return;
	}

	frappe.call({
		method: 'meeting_manager.www.create-meeting.index.get_department_members_list',
		args: { department: department },
		callback: function(r) {
			memberSelect.innerHTML = '<option value="">Select Team Member</option>';

			if (r.message) {
				r.message.forEach(member => {
					const option = document.createElement('option');
					option.value = member.user_id;
					option.textContent = member.full_name;
					memberSelect.appendChild(option);
				});
			}
		}
	});
}

function updateDuration() {
	const meetingType = document.getElementById('customer-meeting-type');
	const selectedOption = meetingType.options[meetingType.selectedIndex];
	currentDuration = selectedOption.dataset.duration || 0;
	checkMemberAvailability();
}

function checkMemberAvailability() {
	const member = document.getElementById('customer-assigned-to').value;
	const date = document.getElementById('customer-date').value;
	const time = document.getElementById('customer-time').value;

	const availabilityDiv = document.getElementById('availability-check');

	if (!member || !date || !time || !currentDuration) {
		availabilityDiv.innerHTML = '';
		return;
	}

	availabilityDiv.innerHTML = '<div class="availability-status checking">‚è≥ Checking availability...</div>';

	frappe.call({
		method: 'meeting_manager.www.create-meeting.index.check_availability',
		args: {
			member: member,
			date: date,
			time: time,
			duration: currentDuration
		},
		callback: function(r) {
			if (r.message && r.message.available) {
				availabilityDiv.innerHTML = '<div class="availability-status available">‚úÖ Member is available at this time</div>';
				document.getElementById('customer-submit').disabled = false;
			} else {
				availabilityDiv.innerHTML = `<div class="availability-status unavailable">‚ùå Member is not available: ${r.message.reason || 'Unknown reason'}</div>`;
				document.getElementById('customer-submit').disabled = true;
			}
		}
	});
}

document.getElementById('customer-meeting-form').addEventListener('submit', function(e) {
	e.preventDefault();

	const data = {
		department: document.getElementById('customer-department').value,
		meeting_type: document.getElementById('customer-meeting-type').value,
		assigned_to: document.getElementById('customer-assigned-to').value,
		scheduled_date: document.getElementById('customer-date').value,
		scheduled_start_time: document.getElementById('customer-time').value,
		customer_name: document.getElementById('customer-name').value,
		customer_email: document.getElementById('customer-email').value,
		customer_phone: document.getElementById('customer-phone').value,
		customer_notes: document.getElementById('customer-notes').value
	};

	document.getElementById('customer-submit').disabled = true;
	document.getElementById('customer-submit').textContent = 'Creating...';

	frappe.call({
		method: 'meeting_manager.meeting_manager.api.booking.create_customer_booking_for_member',
		args: { booking_data: data },
		callback: function(r) {
			if (r.message && r.message.success) {
				showSuccess('customer', `
					<h3>‚úÖ Customer Meeting Created!</h3>
					<p><strong>Booking ID:</strong> ${r.message.booking_id}</p>
					<p>${r.message.message}</p>
				`);
				document.getElementById('customer-meeting-form').reset();
				document.getElementById('availability-check').innerHTML = '';
			} else {
				showError('customer', r.message.message || 'Failed to create meeting');
			}
		},
		error: function(err) {
			showError('customer', err.message || 'An error occurred while creating the meeting');
		},
		always: function() {
			document.getElementById('customer-submit').disabled = false;
			document.getElementById('customer-submit').textContent = 'Create Customer Meeting';
		}
	});
});

function showSuccess(formType, message) {
	const successDiv = document.getElementById(formType + '-success');
	successDiv.className = 'success-message';
	successDiv.innerHTML = message;
	successDiv.style.display = 'block';
	document.getElementById(formType + '-error').style.display = 'none';

	// Scroll to top
	window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showError(formType, message) {
	const errorDiv = document.getElementById(formType + '-error');
	errorDiv.className = 'error-message';
	errorDiv.innerHTML = `<h3>‚ùå Error</h3><p>${message}</p>`;
	errorDiv.style.display = 'block';
	document.getElementById(formType + '-success').style.display = 'none';

	// Scroll to top
	window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %}
